<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission Management</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>
    :root {
      --bg: #12161d;
      --panel: #1e232b;
      --accent: #2d333b;
      --text: #ffffff;
      --muted: #a0a0a0;
      --highlight: #3a8eed;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      height: 100vh;
      gap: 10px;
      padding: 10px;
    }
    .panel {
      background: var(--panel);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel h2 {
      margin: 0 0 10px;
      font-size: 1.2rem;
      border-bottom: 1px solid var(--accent);
      padding-bottom: 5px;
    }
    #map {
      flex-grow: 1;
      width: 100%;
      border-radius: 8px;
      min-height: 0;
    }
    #chatMessages, #commsLog, #fileList {
      flex: 1;
      overflow-y: auto;
      background: var(--accent);
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 10px;
    }
    input, button, textarea {
      background: #2a2f38;
      color: white;
      border: 1px solid #444;
      border-radius: 4px;
      padding: 0.5rem;
      margin-top: 5px;
    }
    #fileList li { padding: 5px 0; border-bottom: 1px solid #444; }
    #chatInput, #commsInput { width: 100%; }
    #profileBtn, #logoutBtn, #voiceBtn {
      position: fixed; padding: 10px 15px; border: none; color: white; border-radius: 5px; cursor: pointer; z-index: 1000;
    }
    #profileBtn { bottom:15px; right:15px; background: var(--highlight); }
    #logoutBtn { top:15px; right:15px; background: red; display:none; }
    #voiceBtn { top:15px; right:115px; background: green; display:none; }
    #profileSearch {
      display:none; position: fixed; bottom:60px; right:15px; background: var(--panel);
      padding:1rem; border-radius:8px; width:300px; z-index:1000;
    }
    #statusBar { font-size:0.9rem; margin-bottom:5px; }
    #profileResult ul { display:grid; grid-template-columns:1fr 1fr; gap:4px; margin:0; padding:0; }
    #profileResult li { background: var(--accent); padding:4px; border-radius:4px; }
    /* Tracking UI */
    #controls { margin-bottom:10px; }
    #addAircraftBtn {
      background: var(--highlight); color:white; border:none; padding:6px 12px; border-radius:4px; cursor:pointer;
    }
    #trackedList span {
      background: var(--accent); padding:5px 10px; border-radius:4px; margin-right:5px; display:inline-block;
    }
    .remove-btn { margin-left:8px; color:red; cursor:pointer; }
    #addPopup {
      display:none; position:fixed; top:50%; left:50%;
      transform:translate(-50%,-50%);
      background: var(--panel); padding:20px; border-radius:8px; z-index:2000;
    }
    #addPopup input {
      width:100%; padding:8px; background: var(--accent); color:white; border:1px solid #444; border-radius:4px;
      margin-bottom:10px;
    }
    #addPopup button {
      padding:6px 12px; border:none; border-radius:4px; margin-right:8px; cursor:pointer;
    }
    #addPopup .add { background: var(--highlight); color:white; }
    #addPopup .cancel { background:#444; color:white; }
  </style>
</head>
<body>
  <div id="adminLogin" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999">
    <img src="Logo" alt="Logo" style="width:300px;margin-bottom:1rem" />
    <h2>Login</h2>
    <input id="loginUsername" placeholder="Username" />
    <input type="password" id="loginPassword" placeholder="Password" />
    <button onclick="loginUser()">Login</button>
    <p id="loginError" style="color:red"></p>
    <p style="margin-top:10px;"><a href="https://forms.office.com/r/gDySnXnE7X" target="_blank" style="color:#3a8eed;text-decoration:underline;">Sign up or Reset password</a></p>
  </div>

  <div class="grid" id="mainApp" style="display:none">
    <div class="panel">
      <h2>Incident Command</h2>
      <div id="chatMessages"></div>
      <input type="text" id="chatInput" placeholder="Message #operations" />
      <button onclick="sendChat()">Send</button>
    </div>

    <div class="panel">
      <h2>Unit Tracking</h2>
      <div id="controls">
        <button id="addAircraftBtn" onclick="openAddPopup()">+ Aircraft</button>
        <div id="trackedList"></div>
      </div>
      <div id="statusBar">No aircraft selected. Click + to add.</div>
      <div id="map"></div>
    </div>

    <div class="panel">
      <h2>Comms Log</h2>
      <div id="commsLog"></div>
      <input type="text" id="commsInput" placeholder="Log entry" />
      <button onclick="logComms()">Log</button>
    </div>

    <div class="panel">
      <h2>File Sharing</h2>
      <input type="file" id="fileUpload" />
      <button onclick="uploadFile()">Upload</button>
      <ul id="fileList"></ul>
    </div>
  </div>

  <button id="profileBtn" onclick="toggleProfileSearch()">Search Profiles</button>
  <button id="logoutBtn" onclick="logoutUser()">Logout</button>
  <button id="voiceBtn" onclick="toggleVoiceChannel()">Join Voice</button>
  <div id="profileSearch">
    <input type="text" id="searchBox" placeholder="Search by name..." />
    <div id="profileResult"></div>
  </div>

  <div id="addPopup">
    <h3>Add Aircraft</h3>
    <input type="text" id="aircraftInput" placeholder="Callsign or tail number" />
    <button class="add" onclick="addAircraft()">Add</button>
    <button class="cancel" onclick="closeAddPopup()">Cancel</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.11.1/simplepeer.min.js"></script>

  <script>
    const capApp = firebase.initializeApp({
      apiKey: "...", authDomain: "...", projectId: "...", storageBucket: "...",
      messagingSenderId: "...", appId: "...", measurementId: "...",
      databaseURL: "..."
    }, "capApp");
    const dbCAP = capApp.database();
    const db = firebase.initializeApp({
      apiKey: "...", authDomain: "...", databaseURL: "...",
      projectId: "...", storageBucket: "...", messagingSenderId: "...",
      appId: "...", measurementId: "..."
    }, "missionApp").database();

    const missionKey = 'demo-mission';
    const map = L.map('map').setView([37.5, -119], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const statusBar = document.getElementById('statusBar');
    const trackedListEl = document.getElementById('trackedList');
    const markers = {};
    const trackedCallsigns = [];

    function openAddPopup() {
      document.getElementById('addPopup').style.display = 'block';
      document.getElementById('aircraftInput').focus();
    }
    function closeAddPopup() {
      document.getElementById('aircraftInput').value = '';
      document.getElementById('addPopup').style.display = 'none';
    }
    function addAircraft() {
      const val = document.getElementById('aircraftInput').value.trim().toUpperCase();
      if (val && !trackedCallsigns.includes(val)) {
        trackedCallsigns.push(val);
        updateTrackedList();
      }
      closeAddPopup();
    }
    function removeAircraft(val) {
      const idx = trackedCallsigns.indexOf(val);
      if (idx > -1) { trackedCallsigns.splice(idx,1); updateTrackedList(); }
    }
    function updateTrackedList() {
      trackedListEl.innerHTML = trackedCallsigns.map(c=>
        `<span>${c}<span class="remove-btn" onclick="removeAircraft('${c}')">❌</span></span>`
      ).join('');
    }

    async function fetchLiveAircraft() {
      try {
        const res = await fetch("https://opensky-network.org/api/states/all");
        if (!res.ok) return null;
        const json = await res.json();
        return json.states || [];
      } catch {
        return null;
      }
    }

    async function updateAircraftMarkers() {
      const live = await fetchLiveAircraft();
      if (!live) { statusBar.textContent="Error loading live aircraft."; return; }

      const active = new Set();
      let found = 0;

      live.forEach(state => {
        const [icao, csRaw, , , , lng, lat, alt, , spd] = state;
        if (!csRaw || lat==null || lng==null) return;
        const cs = csRaw.trim().toUpperCase();
        if (!trackedCallsigns.includes(cs)) return;

        found++;
        active.add(cs);
        if (!markers[cs]) markers[cs]=L.marker([lat,lng]).addTo(map).bindPopup('');
        else markers[cs].setLatLng([lat,lng]);
        markers[cs].setPopupContent(`<b>Callsign:</b> ${cs}<br><b>ICAO:</b>${icao}<br><b>Alt:</b>${alt?.toFixed(0)||'N/A'} ft<br><b>Spd:</b>${spd?.toFixed(0)||'N/A'} kt`);
      });

      Object.keys(markers).forEach(cs=>{
        if (!active.has(cs)) { map.removeLayer(markers[cs]); delete markers[cs]; }
      });

      if (trackedCallsigns.length===0) statusBar.textContent="No aircraft selected. Click + to add.";
      else if (found===0) statusBar.textContent=`No matching aircraft in the air.`;
      else statusBar.textContent=`Tracking ${found} of ${trackedCallsigns.length} aircraft`;
    }

    setInterval(updateAircraftMarkers,15000);
    updateAircraftMarkers();

    // Chat, comms, files, auth, voice code continues unchanged...
    const chatMessagesEl = document.getElementById('chatMessages');
    const commsLogEl = document.getElementById('commsLog');
    const fileListEl = document.getElementById('fileList');
    let currentUser=null;
    const users={ "Kendrick Uhles":"...", "Laramie Uhles":"...", "Ryan Uhles":"..." };
    function loginUser(){
      const u=document.getElementById("loginUsername").value.trim();
      const p=document.getElementById("loginPassword").value.trim();
      if(users[u]===p){
        currentUser=u; document.getElementById("adminLogin").style.display="none";
        document.getElementById("mainApp").style.display="grid";
        document.getElementById("logoutBtn").style.display="block";
        document.getElementById("voiceBtn").style.display="block";
        setTimeout(()=>map.invalidateSize(),300);
      } else document.getElementById("loginError").textContent="Invalid login.";
    }
    function logoutUser(){
      currentUser=null; document.getElementById("mainApp").style.display="none";
      document.getElementById("adminLogin").style.display="flex";
      document.getElementById("logoutBtn").style.display="none";
      document.getElementById("voiceBtn").style.display="none";
      leaveVoiceChannel();
    }
    function getTimeStamp(){ return new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}); }
    function sendChat(){
      const msg=document.getElementById('chatInput').value.trim();
      if(msg&&currentUser){
        db.ref(`missions/${missionKey}/chat`).push({text:msg,time:getTimeStamp(),user:currentUser});
        document.getElementById('chatInput').value='';
      }
    }
    function logComms(){
      const ent=document.getElementById('commsInput').value.trim();
      if(ent){
        db.ref(`missions/${missionKey}/comms`).push({text:ent,time:getTimeStamp()});
        document.getElementById('commsInput').value='';
      }
    }
    function uploadFile(){
      const input=document.getElementById('fileUpload');
      if(input.files.length){
        db.ref(`missions/${missionKey}/files`).push({name:input.files[0].name});
        input.value='';
      }
    }

    db.ref(`missions/${missionKey}/chat`).on('value',snap=>{
      const data=snap.val(); chatMessagesEl.innerHTML='';
      if(data) Object.values(data).forEach(m=>{
        const d=document.createElement('div');
        d.textContent=`[${m.time||'??'}] ${m.user||'Unknown'}: ${m.text||m}`;
        chatMessagesEl.appendChild(d);
      });
    });
    db.ref(`missions/${missionKey}/comms`).on('value',snap=>{
      const data=snap.val(); commsLogEl.innerHTML='';
      if(data) Object.values(data).forEach(e=>{
        const d=document.createElement('div');
        d.textContent=`${e.time||'??'} - ${e.text||e}`;
        commsLogEl.appendChild(d);
      });
    });
    db.ref(`missions/${missionKey}/files`).on('value',snap=>{
      const data=snap.val(); fileListEl.innerHTML='';
      if(data) Object.values(data).forEach(f=>{
        const li=document.createElement('li');
        li.textContent=f.name;
        fileListEl.appendChild(li);
      });
    });

    let debounce;
    document.getElementById("searchBox").addEventListener("input",e=>{
      clearTimeout(debounce);
      debounce=setTimeout(searchProfile,300);
    });
    function toggleProfileSearch(){
      document.getElementById("profileSearch").style.display=
       document.getElementById("profileSearch").style.display==="none"?"block":"none";
    }
    function searchProfile(){
      const name=document.getElementById("searchBox").value.trim();
      const box=document.getElementById("profileResult");
      if(!name) return box.innerHTML="";
      db.ref(`profiles/${name}`).once('value',snap=>{
        const d=snap.val();
        box.innerHTML=d? `<strong>${name}</strong><br><ul>${d.qualifications.map(q=>`<li>${q}</li>`).join('')}</ul>`:'Profile not found.';
      });
    }

    let voiceStream=null,peers={},voiceChannelActive=false;
    async function toggleVoiceChannel(){ voiceChannelActive?leaveVoiceChannel():joinVoiceChannel(); }
    async function joinVoiceChannel(){
      document.getElementById("voiceBtn").textContent="Leave Voice";
      voiceChannelActive=true;
      voiceStream=await navigator.mediaDevices.getUserMedia({audio:true});
      const myId=Date.now().toString(), myRef=db.ref(`missions/${missionKey}/voice/${myId}`);
      myRef.set(true); myRef.onDisconnect().remove();
      db.ref(`missions/${missionKey}/voice`).on('value',snap=>{
        const u=snap.val()||{};
        Object.keys(u).forEach(id=>{
          if(id!==myId&&!peers[id]) createVoicePeer(id,myId,myRef);
        });
      });
    }
    function leaveVoiceChannel(){
      document.getElementById("voiceBtn").textContent="Join Voice";
      voiceChannelActive=false;
      Object.values(peers).forEach(p=>p.destroy());
      peers={}; voiceStream?.getTracks().forEach(t=>t.stop());
      db.ref(`missions/${missionKey}/voice`).off();
    }
    function createVoicePeer(rid,myId,myRef){
      const peer=new SimplePeer({initiator: myId<rid, trickle:false, stream:voiceStream});
      peers[rid]=peer;
      const sigRef=db.ref(`missions/${missionKey}/signals/${myId}_${rid}`);
      peer.on('signal',data=>sigRef.set(JSON.stringify(data)));
      db.ref(`missions/${missionKey}/signals/${rid}_${myId}`).on('value',snap=>{
        const v=snap.val(); if(v) peer.signal(JSON.parse(v));
      });
      peer.on('stream',stream=>{
        const a=new Audio();
        a.srcObject=stream; a.play();
      });
    }
    window.addEventListener('resize',()=>map.invalidateSize());
  </script>
</body>
</html>
